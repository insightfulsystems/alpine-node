  parameters:
    vmImage: 'ubuntu-latest'
    timeout: 60
 
  jobs:
  - job: ${{ parameters.arch }}
    displayName: Build ${{ parameters.arch }}
    timeoutInMinutes: ${{ parameters.timeout }}
    pool:
      vmImage: ${{ parameters.vmImage }}
    variables:
      ARCH: ${{ parameters.arch }} 
      DOCKER: docker --config=~/.docker
    steps:
        - script: |
            make qemu
            make wrap-$(ARCH)
          displayName: Setup ${{ parameters.arch }}
        - script: |
            make build-$(ARCH)
          displayName: Build ${{ parameters.arch }}
        - script: |
            echo $(DOCKER_PASSWORD) | $(DOCKER) login --username $(DOCKER_USERNAME) --password-stdin docker.io
            make push-$(ARCH)
          displayName: Push ${{ parameters.arch }}
